# 事务模块与恢复模块设计文档
## 事务模块
利用thrift的`TThreadPoolServer`模块支持多客户端登录服务器。支持set auto commit true/false、begin transaction和commit等指令，实现一个事务中可以对数据库进行多次修改后提交的操作。

采用read committed的隔离级别，读锁在读取数据后会立即释放，写锁则在用户commit之后释放，防止数据的脏读。树形结构的锁策略来管理Table级、Database级和Manager级三种粒度的锁（要获取粗粒度的锁必须先等其子树中的锁被释放，相反申请细粒度的锁必须等待以上粗粒度的锁释放）。

## 恢复模块
实现了WAL机制，在事务commit时写log文件，事务中执行过的数据库修改语句。数据库重启时，首先读取Java序列化文件中存储的数据，再读取log中的指令对数据库进行恢复。log文件设计成csv的格式，每一行代表一次数据库修改操作，包括操作类型、数据库名、表名、行等信息。采用写锁对log文件的写操作进行控制，保证某一时刻只对一个提交了的事务进行记录。